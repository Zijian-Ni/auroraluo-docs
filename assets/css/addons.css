/* ===========================
   Aurora Addons (JS 扩展样式)
   =========================== */

:root {
  --header-offset: 96px; /* 顶部固定元素总高度，必要时可微调 */
  --aside-width: 280px;
  --toc-width: 260px;
  --z-toc: 10002;
  --z-help: 10020;
  --z-overlay: 10030;
  --z-toast: 10040;
  --content-max: 860px;
}

/* --- 核心修复：标题锚点统一偏移（避免被顶栏挡住） --- */
.markdown-section h1[id],
.markdown-section h2[id],
.markdown-section h3[id],
.markdown-section h4[id],
.markdown-section h5[id],
.markdown-section h6[id] {
  scroll-margin-top: var(--header-offset);
}
/* 兜底：即使浏览器不支持 scroll-margin-top，也用锚点占位 */
.markdown-section h1[id]::before,
.markdown-section h2[id]::before,
.markdown-section h3[id]::before,
.markdown-section h4[id]::before,
.markdown-section h5[id]::before,
.markdown-section h6[id]::before {
  content: "";
  display: block;
  height: var(--header-offset);
  margin-top: calc(-1 * var(--header-offset));
  visibility: hidden;
}

/* —— 浮动 TOC —— */
#toc-float {
  position: fixed;
  top: calc(80px + var(--safe-top, 0px));
  right: calc(16px + var(--safe-right, 0px));
  width: var(--toc-width);
  max-height: calc(100vh - 140px);
  overflow: auto;
  background: var(--card, rgba(255,255,255,.65));
  border: 1px solid var(--border, rgba(124,77,255,.18));
  border-radius: 14px;
  padding: 12px 12px 8px;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
  z-index: var(--z-toc);
}
#toc-float h4 { margin: 0 0 6px 2px; font-size: 13px; opacity: .8; }
#toc-float ul { list-style: none; padding: 0; margin: 0; }
#toc-float li { margin: 2px 0; }
#toc-float a {
  display: block; font-size: 13px; padding: 6px 8px; border-radius: 8px;
  color: var(--text, #222); text-decoration: none;
}
#toc-float a:hover { background: rgba(124,77,255,.08); }
#toc-float a.active { background: rgba(124,77,255,.15); }
@media (max-width: 1200px) { #toc-float { display: none; } }

/* —— 标题锚点复制 —— */
.heading-anchor { margin-left: .35em; opacity: 0; transition: opacity .15s ease; text-decoration: none; font-size: .9em; }
.heading-mdlink { margin-left: .25em; opacity: 0; transition: opacity .15s ease; text-decoration: none; font-size: .9em; }
h1:hover .heading-anchor, h2:hover .heading-anchor, h3:hover .heading-anchor,
h4:hover .heading-anchor, h5:hover .heading-anchor, h6:hover .heading-anchor,
h1:hover .heading-mdlink, h2:hover .heading-mdlink, h3:hover .heading-mdlink,
h4:hover .heading-mdlink, h5:hover .heading-mdlink, h6:hover .heading-mdlink { opacity: .9; }

/* —— 键盘快捷键帮助弹窗 —— */
.kbd-help-mask { position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: var(--z-help); display: none; }
.kbd-help {
  position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
  width: min(680px, 92vw);
  background: var(--card, rgba(255,255,255,.88));
  border: 1px solid var(--border, rgba(124,77,255,.18));
  border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.2);
  padding: 18px 20px; z-index: var(--z-help); display: none;
}
.kbd-help h3 { margin: 0 0 10px; }
.kbd-help kbd {
  display: inline-block; min-width: 1.6em; text-align: center;
  border: 1px solid var(--border); border-bottom-width: 3px;
  border-radius: 6px; padding: 2px 6px; margin: 0 .25em; background: rgba(0,0,0,.06);
}
.kbd-help table { width: 100%; border-collapse: collapse; font-size: 14px; }
.kbd-help td { padding: 6px 4px; border-bottom: 1px dashed rgba(0,0,0,.08); }
.kbd-help .close { margin-top: 10px; float: right; border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; cursor: pointer; }

/* —— 侧栏工具按钮（展开/折叠） —— */
#sidebar-tools { display: flex; gap: 8px; align-items: center; margin: 8px 8px 10px 8px; }
#sidebar-tools button { font-size: 12px; padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); cursor: pointer; }

/* —— 代码行号 —— */
pre.line-numbers { padding-left: 3.2em !important; }

/* —— 外链标记 —— */
a[target="_blank"].external::after { content: "↗"; margin-left: .25em; font-size: .85em; opacity: .6; }

/* —— 打印优化 —— */
@media print {
  #aurora-theme-toggle, #reading-progress, #back-to-top, #toc-float,
  #cmdk, #prefs-panel, .annotation-bubble, .toast { display: none !important; }
}

/* —— 顶部操作条按钮 —— */
#aurora-theme-toggle { position: fixed; right: 12px; top: 12px; z-index: var(--z-overlay); display: flex; gap: 8px; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
#aurora-theme-toggle button { border: 1px solid var(--border, rgba(0,0,0,.08)); background: var(--card, rgba(255,255,255,.6)); border-radius: 10px; padding: 6px 10px; cursor: pointer; }

/* —— Toast —— */
.toast { position: fixed; right: 18px; bottom: 18px; z-index: var(--z-toast); background: rgba(34,34,34,.95); color: #fff; border-radius: 10px; padding: 10px 14px; max-width: 70vw; box-shadow: 0 6px 30px rgba(0,0,0,.2); opacity: 0; transform: translateY(10px); transition: all .2s ease; }
.toast.show { opacity: 1; transform: translateY(0); }

/* —— Command Palette —— */
#cmdk-mask { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; z-index: var(--z-overlay); }
#cmdk { position: fixed; left: 50%; top: 18%; transform: translateX(-50%); width: min(720px, 92vw); background: var(--card, #fff); border: 1px solid var(--border, rgba(0,0,0,.1)); border-radius: 12px; box-shadow: 0 40px 120px rgba(0,0,0,.2); display: none; z-index: var(--z-overlay); }
#cmdk input { width: 100%; padding: 12px 14px; font-size: 16px; border: none; outline: none; border-bottom: 1px solid rgba(0,0,0,.07); border-radius: 12px 12px 0 0; background: transparent; }
#cmdk .list { max-height: 52vh; overflow: auto; }
#cmdk .item { padding: 10px 14px; border-bottom: 1px dashed rgba(0,0,0,.05); cursor: pointer; }
#cmdk .item.active { background: rgba(124,77,255,.12); }

/* —— 偏好面板 —— */
#prefs-mask { position: fixed; inset: 0; background: rgba(0,0,0,.25); display: none; z-index: var(--z-overlay); }
#prefs-panel { position: fixed; right: 16px; top: 56px; width: 320px; background: var(--card, rgba(255,255,255,.96)); border: 1px solid var(--border, rgba(0,0,0,.1)); border-radius: 12px; box-shadow: 0 20px 80px rgba(0,0,0,.25); display: none; z-index: var(--z-overlay); padding: 12px 12px 10px; }
#prefs-panel h4 { margin: 4px 0 10px; }
#prefs-panel .row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; }
#prefs-panel input[type="range"] { width: 160px; }
#prefs-panel .small { font-size: 12px; opacity: .75; }

/* 内容宽度/字号/换行类 */
.content-narrow .markdown-section { max-width: 720px; }
.content-default .markdown-section { max-width: var(--content-max); }
.content-wide .markdown-section    { max-width: 1080px; }
.text-scale-90  { font-size: 90%; }
.text-scale-100 { font-size: 100%; }
.text-scale-110 { font-size: 110%; }
.text-scale-120 { font-size: 120%; }
.code-wrap pre code { white-space: pre-wrap; word-break: break-word; }

/* —— 阅读指标 —— */
.reading-meta { font-size: 13px; opacity: .75; margin: 6px 0 12px; display: flex; gap: 12px; flex-wrap: wrap; }

/* —— 标注/高亮 —— */
.annotation-highlight { background: linear-gradient(transparent 60%, rgba(255,235,59,.7) 60%); cursor: pointer; }
.annotation-bubble { position: fixed; padding: 6px 10px; border-radius: 8px; background: #222; color: #fff; font-size: 12px; transform: translate(-50%, -140%); white-space: nowrap; z-index: var(--z-overlay); display: none; }
.annotations-panel { margin-top: 24px; border: 1px solid var(--border, rgba(0,0,0,.1)); border-radius: 10px; padding: 10px; background: var(--card, rgba(255,255,255,.6)); }
.annotations-panel h4 { margin: 4px 0 8px; }
.annotations-panel .note { padding: 8px; border-bottom: 1px dashed rgba(0,0,0,.08); }
.annotations-panel .note:last-child { border-bottom: none; }
.annotations-panel .note .meta { font-size: 12px; opacity: .6; }

/* —— Snackbar—— */
.snackbar { position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: #222; color: #fff; padding: 10px 14px; border-radius: 10px; box-shadow: 0 6px 30px rgba(0,0,0,.25); z-index: var(--z-toast); display: none; }
.snackbar.show { display: block; }
.snackbar button { margin-left: 10px; background: #7c4dff; color: #fff; border: none; border-radius: 8px; padding: 4px 8px; cursor: pointer; }

/* —— 在线/离线 —— */
#net-indicator { position: fixed; left: 12px; bottom: 12px; z-index: var(--z-overlay); width: 10px; height: 10px; border-radius: 50%; background: #2ecc71; box-shadow: 0 0 0 3px rgba(46,204,113,.2); }
#net-indicator.offline { background: #e74c3c; box-shadow: 0 0 0 3px rgba(231,76,60,.2); }

/* —— 脚注弹出 —— */
.footnote-pop { position: absolute; max-width: 420px; background: var(--card, #fff); border: 1px solid var(--border, rgba(0,0,0,.1)); border-radius: 10px; padding: 8px 10px; box-shadow: 0 12px 40px rgba(0,0,0,.2); z-index: var(--z-overlay); display: none; }

/* —— 术语词汇 —— */
abbr.glossary { text-decoration: underline dotted; cursor: help; }

/* —— 小屏适配 —— */
@media (max-width: 480px) { #cmdk { top: 10%; } }

/* === 动态对齐顶栏到 Sidebar 右缘（由 JS 写入 --sidebar-offset） === */
:root {
  /* JS（nav-align.js）会根据 Sidebar 可见宽度实时更新该变量 */
  --sidebar-offset: 0px;
}

/* 让 app-nav.no-badge 永远从 Sidebar 右缘开始，并占满剩余宽度 */
.app-nav.no-badge {
  margin-left: var(--sidebar-offset);
  width: calc(100% - var(--sidebar-offset));
  box-sizing: border-box;
  transition: margin-left .2s ease, width .2s ease;
}

/* 避免内部元素撑破（可选，提升小屏表现） */
.app-nav.no-badge * {
  min-width: 0;
}
